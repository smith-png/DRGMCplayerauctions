import { useState, useEffect } from 'react';
import { teamsAPI, playerAPI, authAPI, adminAPI, auctionAPI } from '../services/api';
import './Teams.css';

export default function Teams() {
    const [teams, setTeams] = useState([]);
    const [players, setPlayers] = useState([]);
    const [transactions, setTransactions] = useState([]);
    const [filteredTeams, setFilteredTeams] = useState([]);
    const [activeSport, setActiveSport] = useState('Cricket');
    const [loading, setLoading] = useState(true);
    const [user, setUser] = useState(null);
    const [myTeam, setMyTeam] = useState(null);
    const [expandedTeam, setExpandedTeam] = useState(null);

    useEffect(() => {
        const fetchUser = async () => {
            try {
                const token = localStorage.getItem('token');
                if (token) {
                    const response = await authAPI.getCurrentUser();
                    setUser(response.data.user);
                }
            } catch (error) {
                console.log('Not authenticated');
            }
        };
        fetchUser();
    }, []);

    useEffect(() => {
        const fetchData = async () => {
            try {
                const teamsRes = await teamsAPI.getAllTeams('');
                const teamsList = teamsRes.data.teams || [];
                setTeams(teamsList);

                // Fetch players if user is authenticated
                if (user) {
                    const playersRes = await playerAPI.getAllPlayers();
                    const allPlayers = playersRes.data.players || playersRes.data || [];
                    const parsedPlayers = allPlayers.map(p => {
                        let stats = p.stats;
                        if (typeof stats === 'string') {
                            try { stats = JSON.parse(stats); } catch (e) { stats = {}; }
                        }
                        return { ...p, stats: stats || {} };
                    });
                    setPlayers(parsedPlayers);

                    // Fetch transactions for admin
                    if (user.role === 'admin') {
                        try {
                            const transRes = await auctionAPI.getTransactions().catch(() =>
                                adminAPI.getRecentBids().catch(() => ({ data: { transactions: [] } }))
                            );
                            const allTrans = transRes.data.transactions || transRes.data.bids || transRes.data.recentBids || [];
                            setTransactions(allTrans);
                        } catch (err) {
                            console.log('Could not fetch transactions');
                        }
                    }

                    // Find team owner's team
                    if (user.role === 'team_owner' && user.team_id) {
                        const foundTeam = teamsList.find(t => t.id == user.team_id);
                        setMyTeam(foundTeam);
                    }
                }
            } catch (error) {
                console.error('Failed to fetch data:', error);
            } finally {
                setLoading(false);
            }
        };
        if (user !== null) fetchData();
    }, [user, activeSport]);

    useEffect(() => {
        if (!teams) return;
        const targetSport = activeSport.toLowerCase();
        const filteredList = teams.filter(team => (team.sport || '').toLowerCase() === targetSport);
        setFilteredTeams(filteredList);
    }, [activeSport, teams]);

    const handleWalletAdjust = async (teamId, action, amount) => {
        if (!amount || amount <= 0) return alert('Invalid amount');
        try {
            await adminAPI.adjustTeamWallet(teamId, action, amount);
            alert(`Wallet ${action}ed successfully`);
            window.location.reload();
        } catch (err) {
            alert('Failed to adjust wallet');
        }
    };

    // PUBLIC VIEW (Non-authenticated users)
    if (!user) {
        return (
            <div className="editorial-glass-stage">
                <div className="phantom-nav-spacer"></div>
                <div className="teams-page">
                    <div className="teams-header">
                        <div className="header-left">
                            <div className="header-meta">AUCTION TERMINAL // 2026 EDITION</div>
                            <h1 className="header-title">THE<br />TEAMS</h1>
                        </div>
                        <div className="header-right">
                            <div className="header-meta">SPORT: {activeSport.toUpperCase()}</div>
                        </div>
                    </div>

                    <div className="sport-tabs-container">
                        {['Cricket', 'Futsal', 'Volleyball'].map(sport => (
                            <button
                                key={sport}
                                className={`sport-tab ${activeSport === sport ? 'active' : ''}`}
                                onClick={() => setActiveSport(sport)}
                            >
                                {sport}
                            </button>
                        ))}
                    </div>

                    {loading ? <div className="loading-state">SYNCHRONIZING DATA...</div> : (
                        <div className="teams-list">
                            {filteredTeams.map(team => {
                                const budgetRemaining = team.remaining_budget || team.budget || 0;
                                const budgetTotal = team.budget || 2000;
                                const budgetUsedPercent = ((budgetTotal - budgetRemaining) / budgetTotal) * 100;

                                return (
                                    <div key={team.id} className="franchise-strip">
                                        <div className="strip-identity">
                                            <div className="team-name-main">{team.name}</div>
                                            <div className="owner-subtitle">OWNER: {team.owner_name || 'N/A'}</div>
                                        </div>

                                        <div className="strip-budget">
                                            <div className="budget-header">
                                                <span className="budget-label">CAP LEFT</span>
                                                <span className="budget-value">{budgetRemaining.toLocaleString()} PTS</span>
                                            </div>
                                            <div className="budget-track">
                                                <div className="budget-fill" style={{ width: `${Math.max(0, 100 - budgetUsedPercent)}%` }}></div>
                                            </div>
                                        </div>

                                        <div className="strip-roster">
                                            <div className="roster-badge">
                                                {team.player_count || 0}/{
                                                    activeSport === 'Futsal' ? 8 :
                                                        activeSport === 'Volleyball' ? 7 : 15
                                                }
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}

                    {filteredTeams.length === 0 && !loading && (
                        <div className="empty-state">NO RECORD FOUND FOR THIS CATEGORY.</div>
                    )}
                </div>
            </div>
        );
    }

    // TEAM OWNER VIEW
    if (user.role === 'team_owner') {
        if (!myTeam) {
            return (
                <div className="editorial-glass-stage">
                    <div className="phantom-nav-spacer"></div>
                    <div className="teams-page">
                        <div className="stats-error" style={{ flexDirection: 'column', gap: '1rem', textAlign: 'center', padding: '4rem' }}>
                            <div style={{ fontSize: '1.5rem', fontWeight: 'bold' }}>TEAM NOT LINKED</div>
                            <div style={{ fontSize: '0.9rem', color: '#666' }}>USER: {user.name}</div>
                            <div>CONTACT ADMIN FOR TEAM ASSIGNMENT</div>
                        </div>
                    </div>
                </div>
            );
        }

        const myPlayers = players.filter(p => p.team_id == myTeam.id && p.status === 'sold');
        const budgetUsed = (myTeam.budget || 2000) - (myTeam.remaining_budget || 0);
        const burnRate = myTeam.budget ? (budgetUsed / myTeam.budget) * 100 : 0;

        return (
            <div className="editorial-glass-stage">
                <div className="phantom-nav-spacer"></div>
                <div className="teams-page owner-view">
                    <div className="teams-header">
                        <div className="header-left">
                            <div className="header-meta">PORTFOLIO /// {myTeam.name.toUpperCase()}</div>
                            <h1 className="header-title">TEAM<br />REPORT</h1>
                        </div>
                        <div className="header-right">
                            <div className="header-meta">SPORT: {myTeam.sport?.toUpperCase()}</div>
                        </div>
                    </div>

                    {/* KPI Cards */}
                    <div className="kpi-grid">
                        <div className="kpi-card">
                            <span className="kpi-label">REMAINING POINTS</span>
                            <span className="kpi-value highlight">{(myTeam.remaining_budget || 0).toLocaleString()} PTS</span>
                            <div className="kpi-bar-bg">
                                <div className="kpi-bar-fill" style={{ width: `${Math.max(0, 100 - burnRate)}%` }}></div>
                            </div>
                        </div>
                        <div className="kpi-card">
                            <span className="kpi-label">SPENT POINTS</span>
                            <span className="kpi-value">{budgetUsed.toLocaleString()} PTS</span>
                        </div>
                        <div className="kpi-card">
                            <span className="kpi-label">ROSTER SIZE</span>
                            <span className="kpi-value">{myPlayers.length} PLAYERS</span>
                        </div>
                    </div>

                    {/* Player Roster */}
                    <div className="roster-section">
                        <h2 className="section-title">SQUAD ROSTER</h2>
                        <div className="players-grid">
                            {myPlayers.map(player => (
                                <div key={player.id} className="player-card-compact">
                                    <div className="player-card-header">
                                        <span className="player-name">{player.name}</span>
                                        <span className="player-price">{player.sold_price?.toLocaleString()} PTS</span>
                                    </div>
                                    <div className="player-card-meta">
                                        <span>{player.year}</span>
                                        <span>•</span>
                                        <span>{player.sport}</span>
                                    </div>
                                </div>
                            ))}
                        </div>
                        {myPlayers.length === 0 && (
                            <div className="empty-state">NO PLAYERS ACQUIRED YET</div>
                        )}
                    </div>
                </div>
            </div>
        );
    }

    // ADMIN VIEW
    if (user.role === 'admin') {
        const teamsWithRosters = filteredTeams.map(team => {
            const teamRoster = players.filter(p =>
                p.team_id == team.id &&
                p.sport?.toLowerCase() === activeSport.toLowerCase() &&
                p.status === 'sold'
            );
            return { ...team, roster: teamRoster };
        });

        return (
            <div className="editorial-glass-stage">
                <div className="phantom-nav-spacer"></div>
                <div className="teams-page admin-view">
                    <div className="teams-header">
                        <div className="header-left">
                            <div className="header-meta">OFFICIAL /// {activeSport.toUpperCase()}</div>
                            <h1 className="header-title">AUCTION<br />LEDGER</h1>
                        </div>
                    </div>

                    <div className="sport-tabs-container">
                        {['Cricket', 'Futsal', 'Volleyball'].map(sport => (
                            <button
                                key={sport}
                                className={`sport-tab ${activeSport === sport ? 'active' : ''}`}
                                onClick={() => setActiveSport(sport)}
                            >
                                {sport}
                            </button>
                        ))}
                    </div>

                    {loading ? <div className="loading-state">SYNCHRONIZING DATA...</div> : (
                        <div className="admin-content-wrapper">
                            <div className="admin-ledger">
                                {teamsWithRosters.map(team => {
                                    const budgetRemaining = team.remaining_budget || team.budget || 0;
                                    const budgetTotal = team.budget || 2000;
                                    const isExpanded = expandedTeam === team.id;

                                    return (
                                        <div key={team.id} className="ledger-team-block">
                                            <div
                                                className="ledger-team-header"
                                                onClick={() => setExpandedTeam(isExpanded ? null : team.id)}
                                            >
                                                <div className="ledger-team-info">
                                                    <h3 className="ledger-team-name">{team.name}</h3>
                                                    <span className="ledger-team-owner">OWNER: {team.owner_name || 'N/A'}</span>
                                                </div>
                                                <div className="ledger-team-stats">
                                                    <div className="ledger-stat">
                                                        <span className="ledger-stat-label">BUDGET</span>
                                                        <span className="ledger-stat-value">{budgetRemaining.toLocaleString()} PTS</span>
                                                    </div>
                                                    <div className="ledger-stat">
                                                        <span className="ledger-stat-label">ROSTER</span>
                                                        <span className="ledger-stat-value">{team.roster.length}</span>
                                                    </div>
                                                    <button className="expand-btn">{isExpanded ? '−' : '+'}</button>
                                                </div>
                                            </div>

                                            {isExpanded && (
                                                <div className="ledger-team-details">
                                                    <div className="wallet-controls">
                                                        <button
                                                            onClick={() => {
                                                                const amt = prompt('Enter amount to add:');
                                                                if (amt) handleWalletAdjust(team.id, 'add', parseInt(amt));
                                                            }}
                                                            className="wallet-btn add"
                                                        >
                                                            + ADD FUNDS
                                                        </button>
                                                        <button
                                                            onClick={() => {
                                                                const amt = prompt('Enter amount to deduct:');
                                                                if (amt) handleWalletAdjust(team.id, 'deduct', parseInt(amt));
                                                            }}
                                                            className="wallet-btn deduct"
                                                        >
                                                            − DEDUCT FUNDS
                                                        </button>
                                                    </div>
                                                    <div className="roster-list">
                                                        {team.roster.map(player => (
                                                            <div key={player.id} className="roster-player-row">
                                                                <span className="roster-player-name">{player.name}</span>
                                                                <span className="roster-player-year">{player.year}</span>
                                                                <span className="roster-player-price">{player.sold_price?.toLocaleString()} PTS</span>
                                                            </div>
                                                        ))}
                                                        {team.roster.length === 0 && (
                                                            <div className="empty-roster">NO PLAYERS YET</div>
                                                        )}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                    )}

                            {teamsWithRosters.length === 0 && !loading && (
                                <div className="empty-state">NO TEAMS FOUND FOR {activeSport.toUpperCase()}</div>
                            )}
                        </div>
            </div>
                );
    }

                return null;
}
